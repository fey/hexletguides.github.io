<!DOCTYPE html>
<html lang="ru_RU">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="/assets/images/favicons/favicon-128.png">

    
      <link rel="amphtml" href="https://guides.hexlet.io/amp/deploy">
    

    <link type="application/atom+xml" rel="alternate" href="https://guides.hexlet.io/feed.xml" title="Hexlet Guides" />
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Deploy (деплой) - что значит «задеплоить на сервер» простыми словами | Hexlet Guides</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Deploy (деплой) - что значит «задеплоить на сервер» простыми словами" />
<meta name="author" content="Кирилл Мокевнин" />
<meta property="og:locale" content="ru_RU" />
<meta name="description" content="Доставка кода на продакшен сервера. Миграция базы данных. Zero Downtime Deployment. Ansible, Kubernetes" />
<meta property="og:description" content="Доставка кода на продакшен сервера. Миграция базы данных. Zero Downtime Deployment. Ansible, Kubernetes" />
<link rel="canonical" href="https://guides.hexlet.io/deploy/" />
<meta property="og:url" content="https://guides.hexlet.io/deploy/" />
<meta property="og:site_name" content="Hexlet Guides" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-11T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deploy (деплой) - что значит «задеплоить на сервер» простыми словами" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Кирилл Мокевнин"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://guides.hexlet.io/assets/images/hexlet_logo.png"},"name":"Кирилл Мокевнин"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://guides.hexlet.io/deploy/"},"description":"Доставка кода на продакшен сервера. Миграция базы данных. Zero Downtime Deployment. Ansible, Kubernetes","url":"https://guides.hexlet.io/deploy/","headline":"Deploy (деплой) - что значит «задеплоить на сервер» простыми словами","dateModified":"2021-06-11T00:00:00+00:00","datePublished":"2021-06-11T00:00:00+00:00","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    
    

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KMJ8HKG');</script>
<!-- End Google Tag Manager -->




    <link href="/assets/css/theme.css" rel="stylesheet">

    <!-- custom CSS - Remove this if you don't use it or choose to customize the stylesheet with sass-->
    <link href="/assets/css/custom.css" rel="stylesheet">
    <link href="/assets/css/highlight.css" rel="stylesheet">
    <!-- custom CSS end-->

  </head>

  

  <body class="layout-post">

    

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KMJ8HKG"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->



    <!-- Menu Navigation
      ================================================== -->

      <div class="container mb-4">
        <div class="d-flex flex-wrap justify-content-center py-3">
          <a class="navbar-brand me-auto" href="/"><img width="30" alt="Code Basics logo" src="/assets/images/hexlet_logo.png"></a>
          <ul class="nav nav-pills">
            <li class="nav-item">
              <a class="nav-link" target="_blank" href="https://github.com/Hexlet/hexletguides.github.io">Исходный код</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" target="_blank" href="https://ru.hexlet.io/programs?utm_source=hexlet-guides&utm_medium=referral">Программы обучения</a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Container
        ================================================== -->
        <main class="container">
          <div class="row">
  <div class="col-sm-8 mx-auto">


    <div class="mainheading">
      <h1 class="posttitle">
          
            Что такое деплой?
          
      </h1>
    </div>


  <!-- Post Featured Image -->
    
  <!-- End Featured Image -->

    <div class="article-post">
      <ul><li><a href="#шаги-деплоя">Шаги деплоя</a><ul><li><a href="#доставка-кода-на-сервер">Доставка кода на сервер</a></li><li><a href="#обновление-базы-данных">Обновление базы данных</a></li><li><a href="#запуск-и-остановка">Запуск и остановка</a></li></ul></li><li><a href="#автоматизация">Автоматизация</a></li><li><a href="#zero-downtime-deployment">Zero Downtime Deployment</a></li><li><a href="#дополнительная-литература">Дополнительная литература</a></li></ul>

      <p>Деплой — процесс «разворачивания» веб-сервиса, например, сайта, в рабочем окружении. Рабочее окружение — место, где сайт запускается и доступен для запросов. Это может быть как готовый хостинг, так и своя собственная серверная инфраструктура.</p>

<p><em>Деплоятся не только веб-сервисы, но любые сервисы, доступные по сети. Даже если эта сеть внутренняя и не доступна для запросов через интернет.</em></p>

<p>Для понимания деплоя необходимо разобраться с жизненным циклом кода. Код приложения разрабатывается на рабочей машине разработчика, а запускается в другом месте, называемом продакшеном. Продакшен — это среда запуска (иногда говорят боевая среда). В случае простого приложения она может состоять из одного сервера, а может — из тысяч и десятков тысяч в случае по-настоящему сложных приложений.</p>

<p>Как это происходит. Разработчики добавляют код в репозиторий. В какой-то момент они решают, что пора доставить его до продакшена. Это может происходить как по регулярному расписанию, например раз в две недели, так и просто по необходимости, вплоть до выкатки после каждого изменения. Во многом количество деплоев зависит от уровня его автоматизации — того, насколько процесс легкий в проведении и откате в случае проблем. На Хекслете деплои выполняются практически после каждого изменения, около 3 деплоев в день.</p>

<div class="fs-3 border-start p-4 mb-3 bg-light border-info border-3 banner">
    <a href="https://ru.hexlet.io/programs/devops-for-programmers?utm_source=hexlet-guides&amp;utm_medium=referral" target="_blank">Интенсив: Девопс для программистов. Вся база за 3 месяца
</a>
</div>

<p>Каждый раз, когда разработчики решили что все, пора, они создают релиз. Под релизом обычно понимают тег в Git, который фиксирует, что уйдет в деплой. То есть изменения, добавленные в мастер после создания тега, не повлияют на сам тег, а значит мы точно уверены в том, что деплоим.</p>

<!-- image -->

<p>Для статических сайтов или отдельного фронтенда (только HTML, CSS и статические файлы) деплой сводится к обновлению кода на сервере. В ситуации деплоя бэкенда, как минимум, подключается база данных. В общем случае деплой может быть сложной процедурой, занимающей приличное время. В распределенных системах, состоящих из множества независимых веб-сервисов, вообще не бывает общего деплоя — каждая часть приложения деплоится (выкатывается) независимо.</p>

<p><em>Стоит сказать, что PaaS-платформы, такие как Heroku, берут деплой полностью на себя. Там достаточно выполнить коммит, и дальше все произойдет само. Цена за это — стоимость самой платформы</em></p>

<h2 id="шаги-деплоя">Шаги деплоя</h2>

<h3 id="доставка-кода-на-сервер">Доставка кода на сервер</h3>

<p>Возможны разные варианты доставки кода на сервер в зависимости от способа его упаковки. Иногда код просто копируют на сервер как набор файлов, но такое встречается редко, чаще он обновляется через Git. Раньше был популярен способ деплоя через стандартные пакетные менеджеры Linux-дистрибутивов. Сейчас он тоже встречается, и для определенных ситуаций подходит лучше всего.</p>

<ul>
  <li>Git: <em>git checkout tag-name</em></li>
  <li>Docker: <em>docker pull image-name:tag-name</em></li>
  <li>Apt (Пакет): <em>apt-install application-package-name</em></li>
</ul>

<h3 id="обновление-базы-данных">Обновление базы данных</h3>

<p>Новая версия приложения, как правило, требует изменений в базе данных. Для этого во время (или до) деплоя запускают миграции — специальные скрипты, содержащие правила обновления базы данных. Например sql-скрипты:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">car</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">license_plate</span> <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">color</span> <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">owner</span> <span class="k">ADD</span> <span class="n">driver_license_id</span> <span class="nb">VARCHAR</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="запуск-и-остановка">Запуск и остановка</h3>

<p>Где-то в этом процессе происходит остановка старой версии и запуск новой. Если сначала остановить старую версию, а потом выполнить миграции и запустить новую, то мы получим простой (downtime) в работе сервиса. Так действительно работают многие, но это может быть болезненно для бизнеса и частых деплоев. Поэтому самые продвинутые проекты не останавливаются во время деплоя. О том, как это делать — ниже.</p>

<h2 id="автоматизация">Автоматизация</h2>

<p>Деплой нужно максимально автоматизировать, от этого зависит Time To Market, ключевая характеристика бизнес-ориентированных приложений. Чем быстрее и чаще мы доставляем изменения пользователю, тем лучше. Быстрее проверяем гипотезы, быстрее вносим исправления, быстрее оправдываем деньги, вложенные в разработку. Без автоматизации разработчики боятся выполнять деплой, он становится обузой, что приводит к снижению числа деплоев и регулярному стрессу для всей команды, с засиживанием на работе до позднего вечера.</p>

<p>Основных способа автоматизации три:</p>

<ol>
  <li>С помощью утилит, созданных для конкретных языков. Например в Ruby это Capistrano, одна из первых и наиболее известных утилит подобного рода, ставшая популярной далеко за пределами Ruby. Основная проблема с такими инструментами — сильная завязка на язык.</li>
  <li>С помощью Ansible, в который уже <a href="https://docs.ansible.com/ansible/latest/collections/community/general/deploy_helper_module.html">встроен модуль для деплоя</a>. Идеально подходит для большинства ситуаций деплоя на управляемые сервера.</li>
  <li>Системы оркестрации типа Kubernetes. Если они используются, то без автоматического деплоя никак.</li>
</ol>

<p>Но даже если автоматизация выполнена, все равно остается задача «запустить деплой». Запуск тоже автоматизируется. Существует целый подход, который называется <a href="https://ru.wikipedia.org/wiki/Непрерывная_доставка">Непрерывная доставка</a>(continuous delivery). Его сложно внедрить и он не везде подходит, но если получилось, то про деплой забывают. Он выполняется полностью сам без участия людей. Главное в таком варианте — хороший мониторинг и система оповещения (алертинг) для реакции на ошибки.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="c1"># https://docs.ansible.com/ansible/latest/collections/community/general/deploy_helper_module.html#examples</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Initialize the deploy root and gather facts</span>
  <span class="na">community.general.deploy_helper</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/path/to/root</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Clone the project to the new release folder</span>
  <span class="na">ansible.builtin.git</span><span class="pi">:</span>
    <span class="na">repo</span><span class="pi">:</span> <span class="s">ansible.builtin.git://foosball.example.org/path/to/repo.git</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v1.1.1</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Add an unfinished file, to allow cleanup on successful finalize</span>
  <span class="na">ansible.builtin.file</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/'</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">touch</span>
</code></pre></div></div>

<h2 id="zero-downtime-deployment">Zero Downtime Deployment</h2>

<p>Если не предпринимать специальных шагов, то каждый деплой будет приводить к остановке (возможно частичной) сервиса. В это время пользователи либо увидят ошибку, либо сообщение о происходящем обновлении. Но такого не происходит на большинстве крупных сервисов в интернете. Почему? Из-за реализации подхода «деплой без даунтайма» (downtime — простои в работе сервиса).</p>

<p>Zero Downtime Deployment выглядит так, как будто сервис никогда не останавливается, но при этом обновляется. Достигается это за счет одновременного запуска старой версии и новой кода. То есть когда деплоится приложение, то сначала поднимается новая версия рядом со старой. И только когда автоматика убеждается, что новая версия запустилась и работает, происходит остановка старой версии. Для выполнения этой процедуры понадобится следующее:</p>

<ol>
  <li>Инфраструктура. Нужен балансировщик, который может переключать трафик (входящие соединения от браузеров или других систем) между старой и новой версией кода. И желательно иметь как минимум два сервера, хотя это и не обязательно.</li>
  <li>Деплой. Процесс деплоя без простоя значительно сложнее, чем с остановкой. Проще всего такой деплой делается на системах оркестрации, например, Kubernetes.</li>
  <li>Культура кода. Обеспечить безостановочную работу невозможно без определенной культуры написания кода. Чтобы старая и новая версия могли работать одновременно, нужно следить за всеми интерфейсами. Важно соблюдение обратной совместимости (работа с api, базой, очередьми и, в целом, любыми хранилищами).</li>
  <li>База данных. Она должна быть обратна совместима между старой и новой версией. Все миграции только вперед (их нельзя откатывать!) и только на добавление. Нельзя удалять и обновлять (переименовывать, менять тип) колонки и таблицы</li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tomcat-deployment-${TARGET_ROLE}</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">tomcat</span>
        <span class="na">role</span><span class="pi">:</span> <span class="s">${TARGET_ROLE}</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tomcat-container</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">tomcat:${TOMCAT_VERSION}</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div></div>

<h2 id="дополнительная-литература">Дополнительная литература</h2>

<ul>
  <li><a href="https://bronevichok.ru/posts/engineering-at-booking.com.html">Инжиниринг в Booking</a></li>
  <li><a href="https://habr.com/ru/company/flant/blog/471620/">Стратегии деплоя</a></li>
  <li><a href="https://www.youtube.com/watch?v=WPCz_U7D8PI">Stateless vs Statefull</a></li>
  <li><a href="https://github.com/ansistrano/deploy">Ansistrano (Ansible + Capistrano)</a></li>
  <li><a href="https://ru.hexlet.io/blog/posts/environment">Среды разработки</a></li>
</ul>

    </div>

    <div class="lead d-flex my-5">
      <span class="me-auto">
        <a href="https://github.com/Hexlet/hexletguides.github.io/tree/master/_posts/2021-06-11-deploy.md" target="_blank">
          Исходный код (github)
        </a>
      </span>

      
        
          <div class="fst-italic">Кирилл Мокевнин</div>
        
      

    </div>

    <!-- Prev/Next -->
    <div class="row PageNavigation mt-4 prevnextlinks d-flex justify-content-between">
      
      <div class="col-md-6 rightborder pl-0">
        <a class="thepostlink" href="https://guides.hexlet.io/usefull-twitter-threads/">&laquo; Полезные треды в твиттере</a>
      </div>
      
      
    </div>
    <!-- End Prev/Next -->

    <section>
      <div id="comments">
        <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'hexlet-guides'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

      </div>
    </section>
  </div>
</div>

        </main>

        <!-- Footer
          ================================================== -->
          <footer class="footer container text-center">

            <ul class="p-0 mb-1 small">
              
              <li>
                <a href="/about/" alt="О проекте">О проекте</a>
              </li>
              
              <li>
                <a href="https://ru.hexlet.io/webinars?utm_source=hexlet-guides&utm_medium=referral" alt="Бесплатные курсы и вебинары" target="_blank">Бесплатные курсы и вебинары</a>
              </li>
              
              <li>
                <a href="https://cv.hexlet.io/" alt="Оценка резюме" target="_blank">Оценка резюме</a>
              </li>
              
              <li>
                <a href="https://codebattle.hexlet.io/" alt="Алгоритмическая прокачка" target="_blank">Алгоритмическая прокачка</a>
              </li>
              
            </ul>
          </footer>

          <!-- JavaScript
            ================================================== -->
            <script src="/assets/js/theme.js"></script>
  </body>
</html>
